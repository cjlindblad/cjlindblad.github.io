{"componentChunkName":"component---src-templates-post-template-js","path":"/posts/reading-some-ruby-source-code","result":{"data":{"markdownRemark":{"id":"b3e4432f-3367-5f6e-8d2a-a56d8dd29f9a","html":"<p>I’m a Ruby newbie, learning the language by doing some old Advent of Code puzzles. In <a href=\"https://adventofcode.com/2015/day/16\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">one of them</a>, I found the Array <code class=\"language-text\">-</code> (minus) method to be very useful. In short, it returns the difference between two arrays. My particular use case was to check if every element in the first array was included in the second one, which would return an empty array:</p>\n<div class=\"gatsby-highlight\" data-language=\"ruby\"><pre class=\"language-ruby\"><code class=\"language-ruby\">irb<span class=\"token operator\">></span> <span class=\"token punctuation\">[</span><span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">-</span> <span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4</span><span class=\"token punctuation\">,</span> <span class=\"token number\">5</span><span class=\"token punctuation\">]</span>\n  <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span></code></pre></div>\n<p>However, my elements weren’t integers but rather custom types. As per <a href=\"https://ruby-doc.org/core-2.7.1/Array.html#method-i-2D\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">the docs</a>, we need to override <code class=\"language-text\">eql?</code> and <code class=\"language-text\">hash</code> to make it work.</p>\n<p>That got me thinking about how a proper hash function is supposed to work. Some prime number times the hash of every member? Not sure. And that got me thinking even more — when would the hash function be used in my case? Under what conditions? Why isn’t <code class=\"language-text\">eql?</code> enough?</p>\n<p>And then I realized that the actual C source code is listed right there in the docs. Let’s dive in!</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token keyword\">static</span> VALUE\n<span class=\"token function\">rb_ary_diff</span><span class=\"token punctuation\">(</span>VALUE ary1<span class=\"token punctuation\">,</span> VALUE ary2<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n    VALUE ary3<span class=\"token punctuation\">;</span>\n    VALUE hash<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">long</span> i<span class=\"token punctuation\">;</span>\n\n    ary2 <span class=\"token operator\">=</span> <span class=\"token function\">to_ary</span><span class=\"token punctuation\">(</span>ary2<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    ary3 <span class=\"token operator\">=</span> <span class=\"token function\">rb_ary_new</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">RARRAY_LEN</span><span class=\"token punctuation\">(</span>ary1<span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;=</span> SMALL_ARRAY_LEN <span class=\"token operator\">||</span> <span class=\"token function\">RARRAY_LEN</span><span class=\"token punctuation\">(</span>ary2<span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;=</span> SMALL_ARRAY_LEN<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span>i<span class=\"token operator\">=</span><span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i<span class=\"token operator\">&lt;</span><span class=\"token function\">RARRAY_LEN</span><span class=\"token punctuation\">(</span>ary1<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            VALUE elt <span class=\"token operator\">=</span> <span class=\"token function\">rb_ary_elt</span><span class=\"token punctuation\">(</span>ary1<span class=\"token punctuation\">,</span> i<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">rb_ary_includes_by_eql</span><span class=\"token punctuation\">(</span>ary2<span class=\"token punctuation\">,</span> elt<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">continue</span><span class=\"token punctuation\">;</span>\n            <span class=\"token function\">rb_ary_push</span><span class=\"token punctuation\">(</span>ary3<span class=\"token punctuation\">,</span> elt<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n        <span class=\"token keyword\">return</span> ary3<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    hash <span class=\"token operator\">=</span> <span class=\"token function\">ary_make_hash</span><span class=\"token punctuation\">(</span>ary2<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span>i<span class=\"token operator\">=</span><span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i<span class=\"token operator\">&lt;</span><span class=\"token function\">RARRAY_LEN</span><span class=\"token punctuation\">(</span>ary1<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">rb_hash_stlike_lookup</span><span class=\"token punctuation\">(</span>hash<span class=\"token punctuation\">,</span> <span class=\"token function\">RARRAY_AREF</span><span class=\"token punctuation\">(</span>ary1<span class=\"token punctuation\">,</span> i<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">continue</span><span class=\"token punctuation\">;</span>\n        <span class=\"token function\">rb_ary_push</span><span class=\"token punctuation\">(</span>ary3<span class=\"token punctuation\">,</span> <span class=\"token function\">rb_ary_elt</span><span class=\"token punctuation\">(</span>ary1<span class=\"token punctuation\">,</span> i<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token function\">ary_recycle_hash</span><span class=\"token punctuation\">(</span>hash<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">return</span> ary3<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>I’m not what you would call a fluent C reader, but we should be able to sort this one out.</p>\n<p>The broad strokes are that we supply our two arrays (named <code class=\"language-text\">ary1</code> and <code class=\"language-text\">ary2</code>), diff them, and store the result in <code class=\"language-text\">ary3</code> which is returned.</p>\n<p>The first bit of conditional logic seems to check if either array is smaller than some constant named <code class=\"language-text\">SMALL_ARRAY_LEN</code> (if we poke around in the <a href=\"https://github.com/ruby/ruby/blob/master/array.c#L47\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">repo</a>, we find that it’s defined to <code class=\"language-text\">16</code>). If so, it will iterate over every element in <code class=\"language-text\">ary1</code> and push it into <code class=\"language-text\">ary3</code> if it is not included in <code class=\"language-text\">ary2</code>. The inclusion check is performed by <code class=\"language-text\">rb_ary_includes_by_eql(ary2, elt)</code>, which we probably can assume runs in O(n) time.</p>\n<p>Okay, so if the number of elements to check is within reason, we do it the brute force way. So, what if it isn’t? Then we make a hash (Ruby for <a href=\"https://docs.python.org/3/tutorial/datastructures.html#dictionaries\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">dictionary</a> or <a href=\"https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Map\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">map</a>) of <code class=\"language-text\">ary2</code> and check inclusion in O(1) time!</p>\n<h3 id=\"-rabbit-hole\" style=\"position:relative;\"><a href=\"#-rabbit-hole\" aria-label=\" rabbit hole permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>&#x3C;🐰 Rabbit hole></h3>\n<p>This raises a question — which Ruby method does <code class=\"language-text\">ary_make_hash</code> correspond to? It certainly isn’t <code class=\"language-text\">to_h</code>:</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\">irb<span class=\"token operator\">></span> <span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>to_h\n\n<span class=\"token function\">TypeError</span> <span class=\"token punctuation\">(</span>wrong element type Integer at <span class=\"token number\">0</span> <span class=\"token punctuation\">(</span>expected array<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>That method <a href=\"https://ruby-doc.org/core-2.7.1/Array.html#method-i-to_h\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">expects one array of keys and one array of values</a>. That isn’t what we’re doing here.</p>\n<p>If we search for <code class=\"language-text\">ary_make_hash</code> in the repo, we only get matches in the <code class=\"language-text\">array.c</code> file. Could this mean that it’s an internal function? Let’s compare it to a method we know is in the public API, like <code class=\"language-text\">unshift</code>. Near the bottom of <code class=\"language-text\">array.c</code>, we find <a href=\"https://github.com/ruby/ruby/blob/master/array.c#L8074\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">this</a>. Seems like the mapping of Ruby method name to C function. We also notice that every C function exposed this way is prefixed with <code class=\"language-text\">rb_</code>, like <code class=\"language-text\">rb_ary_unshift</code>. Now we can be pretty sure that <code class=\"language-text\">ary_make_hash</code> only is used internally. Let’s take a look at it!</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token keyword\">static</span> VALUE\n<span class=\"token function\">ary_make_hash</span><span class=\"token punctuation\">(</span>VALUE ary<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n    VALUE hash <span class=\"token operator\">=</span> <span class=\"token function\">ary_tmp_hash_new</span><span class=\"token punctuation\">(</span>ary<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">return</span> <span class=\"token function\">ary_add_hash</span><span class=\"token punctuation\">(</span>hash<span class=\"token punctuation\">,</span> ary<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">static</span> <span class=\"token keyword\">inline</span> VALUE\n<span class=\"token function\">ary_tmp_hash_new</span><span class=\"token punctuation\">(</span>VALUE ary<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">long</span> size <span class=\"token operator\">=</span> <span class=\"token function\">RARRAY_LEN</span><span class=\"token punctuation\">(</span>ary<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    VALUE hash <span class=\"token operator\">=</span> <span class=\"token function\">rb_hash_new_with_size</span><span class=\"token punctuation\">(</span>size<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token function\">RBASIC_CLEAR_CLASS</span><span class=\"token punctuation\">(</span>hash<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">return</span> hash<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">static</span> VALUE\n<span class=\"token function\">ary_add_hash</span><span class=\"token punctuation\">(</span>VALUE hash<span class=\"token punctuation\">,</span> VALUE ary<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">long</span> i<span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span>i<span class=\"token operator\">=</span><span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i<span class=\"token operator\">&lt;</span><span class=\"token function\">RARRAY_LEN</span><span class=\"token punctuation\">(</span>ary<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t\tVALUE elt <span class=\"token operator\">=</span> <span class=\"token function\">RARRAY_AREF</span><span class=\"token punctuation\">(</span>ary<span class=\"token punctuation\">,</span> i<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t\t<span class=\"token function\">rb_hash_add_new_element</span><span class=\"token punctuation\">(</span>hash<span class=\"token punctuation\">,</span> elt<span class=\"token punctuation\">,</span> elt<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">return</span> hash<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><code class=\"language-text\">ary_make_hash</code> uses two other functions, <code class=\"language-text\">ary_tmp_hash_new</code> and <code class=\"language-text\">ary_add_hash</code>. They’re all listed above, and hopefully, it’s enough to figure out what’s going on. <code class=\"language-text\">ary_tmp_hash_new</code> just creates an empty hash with a size matching the passed array. The solution lies in the line <code class=\"language-text\">rb_hash_add_new_element(hash, elt, elt);</code> from <code class=\"language-text\">ary_add_hash</code> — we get a hash where the keys and values are the same, e.g:</p>\n<div class=\"gatsby-highlight\" data-language=\"ruby\"><pre class=\"language-ruby\"><code class=\"language-ruby\">irb<span class=\"token operator\">></span> <span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>make_hash <span class=\"token comment\">#(Doesn't exist)</span>\n  <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token punctuation\">{</span><span class=\"token number\">1</span><span class=\"token operator\">=</span><span class=\"token operator\">></span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token operator\">=</span><span class=\"token operator\">></span><span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token operator\">=</span><span class=\"token operator\">></span><span class=\"token number\">3</span><span class=\"token punctuation\">}</span></code></pre></div>\n<p>We probably could have guessed it, but where’s the fun in that?</p>\n<h3 id=\"--rabbit-hole\" style=\"position:relative;\"><a href=\"#--rabbit-hole\" aria-label=\"  rabbit hole permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>&#x3C;/ 🐰 Rabbit hole></h3>\n<p>Let’s return to <code class=\"language-text\">rb_ary_diff</code>.</p>\n<div class=\"gatsby-highlight\" data-language=\"ruby\"><pre class=\"language-ruby\"><code class=\"language-ruby\">static <span class=\"token constant\">VALUE</span>\nrb_ary_diff<span class=\"token punctuation\">(</span><span class=\"token constant\">VALUE</span> ary1<span class=\"token punctuation\">,</span> <span class=\"token constant\">VALUE</span> ary2<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token comment\"># other stuff excluded..</span>\n\n    hash <span class=\"token operator\">=</span> ary_make_hash<span class=\"token punctuation\">(</span>ary2<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span>i<span class=\"token operator\">=</span><span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i<span class=\"token operator\">&lt;</span><span class=\"token constant\">RARRAY_LEN</span><span class=\"token punctuation\">(</span>ary1<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>rb_hash_stlike_lookup<span class=\"token punctuation\">(</span>hash<span class=\"token punctuation\">,</span> <span class=\"token constant\">RARRAY_AREF</span><span class=\"token punctuation\">(</span>ary1<span class=\"token punctuation\">,</span> i<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> continue<span class=\"token punctuation\">;</span>\n        rb_ary_push<span class=\"token punctuation\">(</span>ary3<span class=\"token punctuation\">,</span> rb_ary_elt<span class=\"token punctuation\">(</span>ary1<span class=\"token punctuation\">,</span> i<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    ary_recycle_hash<span class=\"token punctuation\">(</span>hash<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">return</span> ary3<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>We make a hash out of <code class=\"language-text\">ary2</code>. Then we’ll iterate over <code class=\"language-text\">ary1</code> and look the elements up in the hash. If they’re not found, we push them onto <code class=\"language-text\">ary3</code>. And since we’re in C land, we got to return the memory for the hash!</p>\n<p>This all means that the requested <code class=\"language-text\">hash</code> override is only ever used if either array is longer than 16 elements, and even then it’s a performance optimization (a really bad hash function turns a hash into a list). In my case, no array is ever longer than 10 elements, so I can safely ignore overriding it without risking any penalties!</p>\n<h3 id=\"conclusion\" style=\"position:relative;\"><a href=\"#conclusion\" aria-label=\"conclusion permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Conclusion</h3>\n<p>In the quest of avoiding learning how to write a proper hash function, I poked around in the Ruby source code and actually learned a thing or two about how things are organized — specifically the naming convention of functions belonging to the public Ruby API. This might be the beginning of a whole lot of Ruby source code spelunking!</p>","fields":{"slug":"/posts/reading-some-ruby-source-code","tagSlugs":["/tag/ruby/"]},"frontmatter":{"date":"2020-07-09T12:40:32.169Z","description":"Where my quest to avoid learning to write proper hash functions made me dive into the Ruby source.","tags":["Ruby"],"title":"Reading some Ruby source code","socialImage":null}}},"pageContext":{"slug":"/posts/reading-some-ruby-source-code"}}}